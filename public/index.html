<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soru Çözücü - Berkant Hoca | Nihai Protokol</title>
    
    <!-- Temel Kütüphaneler (Production Sürümleri) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Matematiksel Gösterim (KaTeX) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    
    <!-- Yazı Tipi -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Stil Kodları -->
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0;
        }
        .animated-gradient {
            background: linear-gradient(-45deg, #1e3a8a, #4c1d95, #3b0764, #2563eb);
            background-size: 400% 400%;
            animation: gradient-move 15s ease infinite;
        }
        @keyframes gradient-move {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .bubbles {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            top: 0;
            left: 0;
            z-index: 0;
        }
        .bubble {
            position: absolute;
            bottom: -150px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: bubble-rise 25s infinite ease-in;
            opacity: 0;
        }
        .bubble:nth-child(1) { width: 40px; height: 40px; left: 10%; animation-duration: 18s; animation-delay: 0s; }
        .bubble:nth-child(2) { width: 20px; height: 20px; left: 20%; animation-duration: 12s; animation-delay: 1s; }
        .bubble:nth-child(3) { width: 50px; height: 50px; left: 25%; animation-duration: 22s; animation-delay: 0s; }
        .bubble:nth-child(4) { width: 80px; height: 80px; left: 35%; animation-duration: 25s; animation-delay: 3s; }
        .bubble:nth-child(5) { width: 35px; height: 35px; left: 50%; animation-duration: 15s; animation-delay: 0s; }
        .bubble:nth-child(6) { width: 45px; height: 45px; left: 65%; animation-duration: 20s; animation-delay: 1s; }
        .bubble:nth-child(7) { width: 25px; height: 25px; left: 75%; animation-duration: 14s; animation-delay: 4s; }
        .bubble:nth-child(8) { width: 65px; height: 65px; left: 90%; animation-duration: 24s; animation-delay: 2s; }
        .bubble:nth-child(9) { width: 15px; height: 15px; left: 85%; animation-duration: 10s; animation-delay: 5s; }
        .bubble:nth-child(10) { width: 40px; height: 40px; left: 5%; animation-duration: 19s; animation-delay: 6s; }
        .bubble:nth-child(11) { width: 55px; height: 55px; left: 30%; animation-duration: 23s; animation-delay: 8s; }
        .bubble:nth-child(12) { width: 20px; height: 20px; left: 58%; animation-duration: 13s; animation-delay: 9s; }
        @keyframes bubble-rise {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 0.7; }
            100% { transform: translateY(-120vh) scale(1.2) rotate(360deg); opacity: 0; }
        }
        .rainbow-active { position: relative; z-index: 1; background: #1a202c; color: white; border: 2px solid transparent; }
        .rainbow-active::before { content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px; background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000); background-size: 400%; border-radius: 0.5rem; z-index: -1; animation: rainbow-move 3s linear infinite; }
        @keyframes rainbow-move { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
        
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #818cf8; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .halkali-title { animation: text-color-change 6s linear infinite; }
        @keyframes text-color-change { 0% {color: #a78bfa;} 25% {color: #f472b6;} 50% {color: #34d399;} 75% {color: #fb923c;} 100% {color: #a78bfa;} }
        
        .answer-button { transition: all 0.2s ease-in-out; }
        .answer-button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .feedback-box { 
            position: relative; 
            z-index: 1; 
            border-radius: 12px; 
            background: linear-gradient(135deg, #1e293b, #312e81);
            color: white; 
            padding: 20px; 
            overflow: hidden; 
            border: 1px solid #4f46e5;
        }

        .katex { color: #d1d5db; }
        .inline-math { 
            display: inline-block; 
            background-color: rgba(71, 85, 105, 0.5); 
            padding: 2px 8px; 
            border-radius: 6px; 
            margin: 0 4px; 
            border: 1px solid #475569; 
            vertical-align: baseline; 
            font-weight: normal !important; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        // Firebase v9+ SDK'ları modül olarak içe aktarılır.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
        import { 
            getFirestore,
            doc,
            getDoc,
            setDoc
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        // Firebase Yapılandırması
        const firebaseConfig = {  
            apiKey: "AIzaSyCl6OUQfR8BvI3S2EJ0pVA-I1-r-JX0aBU",  
            authDomain: "paylassorucozucu.firebaseapp.com",  
            projectId: "paylassorucozucu",  
            storageBucket: "paylassorucozucu.appspot.com",  
            messagingSenderId: "447054434464",  
            appId: "1:447054434464:web:635924b4d7f37c5f4b39c5"  
        };
        
        let firebaseServices = null;
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            firebaseServices = { auth, db, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, doc, setDoc, getDoc };
        } catch (error) {
            console.error("Firebase başlatılamadı! Lütfen firebaseConfig bilgilerini kontrol edin.", error);
            firebaseServices = {}; 
        }
        window.firebaseServices = firebaseServices;
    </script>
    
    <script type="text/babel" data-type="module">
        const { useState, useRef, useEffect, useMemo } = React;
        const { createRoot } = ReactDOM;
        
        const {
            auth, db, onAuthStateChanged, createUserWithEmailAndPassword,
            signInWithEmailAndPassword, signOut, doc, setDoc, getDoc
        } = window.firebaseServices || {};

        // ===================================================================================
        // TASARIM COMPONENT'LERİ
        // ===================================================================================
        const AnimatedBubbles = () => (
            <div className="bubbles">
                {Array.from({ length: 12 }).map((_, i) => <div key={i} className="bubble"></div>)}
            </div>
        );

        const AwaitingApproval = ({ onLogout }) => {
            return (
                <div className="w-full max-w-md mx-auto bg-slate-900/40 backdrop-blur-md border border-slate-700 rounded-2xl shadow-2xl p-6 sm:p-8 text-center">
                    <h1 className="text-3xl font-extrabold text-slate-100">Onay Bekleniyor</h1>
                    <p className="text-slate-300 mt-4">
                        Hesabınız başarıyla oluşturuldu. Uygulamayı kullanabilmek için yöneticinin hesabınızı onaylaması gerekmektedir.
                    </p>
                    <p className="text-slate-400 mt-2 text-sm">
                        Lütfen daha sonra tekrar deneyin.
                    </p>
                    <button 
                        onClick={onLogout}
                        className="w-full mt-8 flex justify-center py-3 px-4 border border-transparent rounded-md shadow-lg text-base font-medium text-white bg-gradient-to-r from-violet-600 to-blue-600 hover:from-violet-700 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-violet-500 transition-all duration-300 transform hover:scale-105"
                    >
                        Çıkış Yap
                    </button>
                </div>
            );
        };

        // ===================================================================================
        // YARDIMCI VE UI COMPONENT'LERİ
        // ===================================================================================
        const LoadingIndicator = ({ message }) => (<div className="mt-4 flex flex-col items-center justify-center"><div className="loader"></div><p className="text-slate-400 mt-2 text-center">{message}</p></div>);
        const FullScreenLoader = () => (<div className="fixed inset-0 bg-slate-900 bg-opacity-75 flex items-center justify-center z-50"><div className="loader"></div></div>);
        
        const AlertDisplay = ({ message, type = 'error' }) => {
            if (!message) return null;
            const baseClasses = "px-4 py-3 rounded-lg relative mb-4 text-center text-sm";
            const typeClasses = {
                error: "bg-pink-500/20 border border-pink-500/30 text-pink-300",
                success: "bg-green-500/20 border border-green-500/30 text-green-300"
            };
            return <div className={`${baseClasses} ${typeClasses[type]}`} role="alert">{message}</div>;
        };
        
        const Modal = ({ title, children, onClose }) => (
            <div className="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                <div className="bg-slate-800/70 border border-slate-700 rounded-lg shadow-2xl max-w-sm w-full">
                    <div className="p-5 border-b border-slate-700"><h3 className="text-xl font-bold text-slate-100">{title}</h3></div>
                    <div className="p-5 text-slate-300">{children}</div>
                    <div className="p-4 bg-slate-900/50 border-t border-slate-700 text-right">
                        <button onClick={onClose} className="px-4 py-2 bg-violet-600 text-white font-semibold rounded-lg hover:bg-violet-700 transition-colors">Anladım</button>
                    </div>
                </div>
            </div>
        );

        const KatexRenderer = ({ content, isBlock }) => {
            const katexRef = useRef(null);
            useEffect(() => { 
                if (katexRef.current && typeof window.katex !== 'undefined' && content) { 
                    try { 
                        window.katex.render(content, katexRef.current, { throwOnError: false, displayMode: isBlock }); 
                    } catch (e) { 
                        console.error("KaTeX render error:", e); 
                        katexRef.current.textContent = content; 
                    } 
                } 
            }, [content, isBlock]);
            return isBlock 
                ? <div ref={katexRef} className="my-2 text-center"></div> 
                : <span ref={katexRef} className="inline-math"></span>;
        };
        
        const renderLineWithMath = (line) => {
            const parts = line.split(/(\$\$[\s\S]*?\$\$|\$[\s\S]*?\$)/g).filter(Boolean);
            return parts.map((part, partIndex) => {
                if (part.startsWith('$$') && part.endsWith('$$')) { return <KatexRenderer key={partIndex} content={part.slice(2, -2)} isBlock={true} />; }
                if (part.startsWith('$') && part.endsWith('$')) { return <KatexRenderer key={partIndex} content={part.slice(1, -1)} isBlock={false} />; }
                return <span key={partIndex}>{part}</span>;
            });
        };

        const UniversalMathRenderer = ({ text, baseTextColor = 'text-slate-300' }) => {
            const parsedContent = useMemo(() => {
                if (!text) return null;
                // \n karakterlerini gerçek satır sonlarına çevir
                const lines = text.replace(/\\n/g, '\n').split('\n');
                return lines.map((line, lineIndex) => (
                    <p key={lineIndex} className={`flex items-baseline flex-wrap ${baseTextColor}`}>{renderLineWithMath(line)}</p>
                ));
            }, [text]);
            return <div>{parsedContent}</div>;
        };

        // ===================================================================================
        // SORU ÇÖZÜCÜ UYGULAMASI
        // ===================================================================================
        const SolutionDisplay = ({ solution, subject }) => {
            const { simplified_question, solution_steps, final_answer, recommendations } = solution;
            const cleanFinalAnswer = (answer) => answer ? answer.replace(/[\$\*]/g, '') : '';
            
            const steps = solution_steps ? solution_steps.split(/\n\n(?=🎯|🔢|➡️|✅|💡|🔍|📝|📌|✔️|➕|➖|➗|✖️|�)/) : [];
            const recommendation_parts = recommendations ? recommendations.split(/\n\n(?=🔑|🚩)/) : [];

            return (
                <div className="space-y-6 mt-6 pt-6 border-t border-slate-700">
                    <div className="text-center"><h2 className="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">  {subject} Sorusu Çözümü</h2></div>
                    
                    {simplified_question && <div className="bg-slate-800/50 p-4 sm:p-5 rounded-lg border-l-4 border-amber-400"><h3 className="flex items-center gap-x-3 text-lg text-amber-300 mb-3"><span className="text-2xl">🤔</span><span>Soruyu Basitleştirelim!</span></h3><UniversalMathRenderer text={simplified_question} /></div>}
                    
                    {steps.length > 0 && (
                        <div className="bg-slate-800/50 p-4 sm:p-5 rounded-lg border-l-4 border-sky-400">
                            <h3 className="flex items-center gap-x-3 text-lg text-sky-300 mb-4"><span className="text-2xl">🚀</span><span>Çözüm Adımları</span></h3>
                            <div className="space-y-3">
                                {steps.map((step, index) => {
                                    const emojiMatch = step.match(/^(🎯|🔢|➡️|✅|💡|🔍|📝|📌|✔️|➕|➖|➗|✖️|🟰)\s*/);
                                    const emoji = emojiMatch ? emojiMatch[0] : null;
                                    const restOfStep = emoji ? step.substring(emoji.length) : step;
                                    return (
                                        <div key={index} className="flex items-start p-3 bg-slate-700/40 rounded-lg">
                                            {emoji && <span className="text-xl mr-3 mt-1">{emoji}</span>}
                                            <div className="flex-1 text-slate-300 leading-relaxed"><UniversalMathRenderer text={restOfStep} /></div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {final_answer && <div className="flex justify-center items-center gap-3 p-4 bg-green-800/30 border border-green-500/30 rounded-lg"><h3 className="flex items-center gap-x-3 text-lg text-green-300"><span className="text-2xl">🎉</span><span>Nihai Cevap:</span></h3><div className="text-lg text-green-200"><KatexRenderer content={cleanFinalAnswer(final_answer)} isBlock={false} /></div></div>}
                    
                    {recommendation_parts.length > 0 && (
                         <div className="bg-slate-800/50 p-4 sm:p-5 rounded-lg border-l-4 border-teal-400">
                             <h3 className="flex items-center gap-x-3 text-lg text-teal-300 mb-4"><span className="text-2xl">📚</span><span>Berkant Hoca'dan Tavsiyeler</span></h3>
                             <div className="space-y-4">
                                {recommendation_parts.map((rec, index) => {
                                    const emojiMatch = rec.match(/^(🔑|🚩)\s*/);
                                    const emoji = emojiMatch ? emojiMatch[0] : null;
                                    const restOfRec = emoji ? rec.substring(emoji.length) : rec;
                                    return(
                                        <div key={index} className="flex items-start">
                                             {emoji && <span className="text-xl mr-3 mt-1">{emoji}</span>}
                                             <div className="flex-1 text-slate-300 leading-relaxed"><UniversalMathRenderer text={restOfRec} /></div>
                                        </div>
                                    )
                                })}
                             </div>
                         </div>
                    )}
                </div>
            );
        };

        const useSoruCozucu = () => {
            const [image, setImage] = useState(null); const [imageBase64, setImageBase64] = useState(''); const [selectedSubject, setSelectedSubject] = useState(null); const [solution, setSolution] = useState(null); 
            const [status, setStatus] = useState('idle'); // idle, loading, success, error
            const [loadingMessage, setLoadingMessage] = useState(''); const [error, setError] = useState(''); const fileInputRef = useRef(null);
            const [showAskTeacher, setShowAskTeacher] = useState(false); const [teacherQuestion, setTeacherQuestion] = useState(''); const [chatHistory, setChatHistory] = useState([]); const [isChatLoading, setIsChatLoading] = useState(false);
            const [toastMessage, setToastMessage] = useState(''); const [showFeedbackButtons, setShowFeedbackButtons] = useState(true);
            const handleFileChange = (event) => { const file = event.target.files[0]; if (file) { reset(); setImage(URL.createObjectURL(file)); const reader = new FileReader(); reader.onloadend = () => setImageBase64(reader.result.split(',')[1]); reader.onerror = () => setError('Dosya okunurken bir hata oluştu.'); reader.readAsDataURL(file); } };
            const triggerFileSelect = () => fileInputRef.current?.click();
            
            const callProxyAPI = async (payload) => {
                const proxyUrl = '/.netlify/functions/gemini-proxy';
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: { message: 'Sunucudan geçersiz bir hata yanıtı alındı.'} }));
                    const errorMessage = errorData.error?.message || `Proxy Hatası (${response.status})`;
                    throw new Error(errorMessage);
                }
                const result = await response.json();
                if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                    return payload.isChat ? result.candidates[0].content.parts[0].text : JSON.parse(result.candidates[0].content.parts[0].text);
                } else {
                    console.error("Unexpected API response from proxy:", result);
                    if(result.promptFeedback && result.promptFeedback.blockReason) {
                         throw new Error(`İstek, güvenlik nedeniyle engellendi: ${result.promptFeedback.blockReason}`);
                    }
                    throw new Error('Proxy\'den beklenen formatta bir yanıt alınamadı.');
                }
            };

            const startSolutionProcess = async (userAnswer, correctionText = null) => { 
                if (!imageBase64 || !selectedSubject) { setError('Lütfen önce bir resim yükleyip ders seçin.'); return; } 
                setStatus('loading'); setLoadingMessage('Soru derinlemesine analiz ediliyor...'); setError(''); setSolution(null); setShowFeedbackButtons(true);
                try { 
                    const prompt = `### PLATİN STANDART PROTOKOLÜ V7 - NİHAİ MÜHÜR ###

**1. PERSONA: PEDAGOJİK MENTOR "BERKANT HOCA"**
Sen, adı "Berkant Hoca" olan, ${selectedSubject} alanında uzman, son derece bilgili ve pedagojik bir yapay zeka eğitimcisin. Görevin sadece soruyu çözmek değil, öğrencinin konuyu temelden anlamasını sağlamaktır. Empati kur, sabırlı ol ve en karmaşık konuları bile basit analojilerle açıkla.

**2. ZORUNLU İÇSEL DÜŞÜNCE ZİNCİRİ (CEVABI ÜRETMEDEN ÖNCE BUNLARI DÜŞÜN)**
   a. **DÜŞÜN (DECONSTRUCT):** Sorudaki tüm verileri, metinleri, sayıları, şekilleri ve gizli bilgileri ayrıştır. "Verilenler ne?", "İstenen ne?", "Sorunun altında yatan temel prensip ne?"
   b. **PLANLA (BLUEPRINT):** Çözüme giden en mantıklı ve en basit yol haritasını adım adım planla.
   c. **UYGULA (GENERATE):** Tüm bu analizleri tamamladıktan sonra, bulgularını aşağıda belirtilen JSON formatında, kusursuz bir şekilde dışa aktar.

**3. LATEX FORMATLAMA - KATI KURALLAR (HATA PAYI SIFIR!)**
   a. **KOPYA KAĞIDI (Sadece Bunları Kullan):**
      - Çarpma için: \`\\\\times\`
      - Bölme için: \`\\\\div\`
      - Kesir için: \`\\\\frac{pay}{payda}\`
      - Karekök için: \`\\\\sqrt{ifade}\`
      - Üslü ifade için: \`x^2\`
      - Metin içinde formül: \`$...$\`
      - Ayrı satırda formül: \`$$...$$\`
      - Türkçe metinler için: Sadece ve sadece birimler veya özel isimler gibi durumlarda \`\\\\text{...}\` kullan. Örnek: \`V_{\\\\text{otobüs}}\`
   b. **KESİNLİKLE YASAKLI FORMATLAR (Bunları ASLA Kullanma):**
      - Markdown formatları: \`**\`, \`*\`, \`#\` vb. KESİNLİKLE YASAKTIR.
      - Anlamsız LaTeX birleştirmeleri: \`ext\`, \`imes\`, \`Vimest\` vb.
      - Tek ters taksimli LaTeX komutları: \`\\times\`, \`\\frac\` vb. (JSON için her zaman çift olmalı: \`\\\\times\`).
      - Matematiksel bir ifadeyi birden fazla '$' bloğuna bölmek. (YANLIŞ: \`$x$ = $5$\`. DOĞRU: \`$x = 5$\`.)
   c. **JSON UYUMLULUĞU:** JSON içinde tüm ters taksimler ('\') çift olmalıdır ('\\\\').

**4. ZORUNLU KENDİNİ ELEŞTİRME (JSON ÜRETMEDEN ÖNCEKİ SON KONTROL)**
   - Yasaklı formatlardan birini kullandım mı? (Kullanmamalısın).
   - JSON formatım geçerli mi? Tüm 4 anahtar da dolu mu?
   - **LATEX KONTROLÜ:** Yasaklı listeden bir komut kullandım mı? Komutlarım kopya kağıdındaki gibi mi? Tüm taksimlerim çift mi?
   - **NİHAİ CEVAP KONTROLÜ:** \`final_answer\` alanına SADECE nihai cevabı (şık veya sonuç) mı yazdım? İçinde KESİNLİKLE cümle var mı? (Olmamalı).
   - Cevaplarım, "Berkant Hoca" personasına uygun, anlaşılır ve pedagojik mi?

**5. DİNAMİK GERİ BİLDİRİM ENTEGRASYONU**
${correctionText ? `- **ÖNCEKİ HATADAN DERS ÇIKAR:** Daha önce bu soruya bir çözüm sundun ama kullanıcı şu geri bildirimi yaptı: "${correctionText}". Bu yeni ve kritik bilgiyi dikkate alarak, düşünce zincirini ve çözümünü yeniden oluştur. Hatayı kabul et ve düzelt.` : ''}

**6. GÖREV: JSON ÇIKTISI ÜRET**
Yukarıdaki tüm protokolü takip ederek, verilen ${selectedSubject} sorusu için aşağıdaki 4 anahtarı içeren bir JSON nesnesi oluştur.

### GİRDİ BİLGİLERİ ###
- **Ders:** ${selectedSubject}
- **Kullanıcının Verdiği Cevap:** ${userAnswer || "Belirtilmedi"}

### İSTENEN JSON FORMATI ###
{
  "simplified_question": "Bu soruda bizden ne istendiğinin basit bir dille açıklaması.",
  "solution_steps": "🎯 1. Adım: ...\\n\\n🔢 2. Adım: ...",
  "final_answer": "Eğer kullanıcının cevabı 'A', 'B', 'C', 'D' veya 'E' ise, SADECE o harfi yaz (Örn: '$C$'). Eğer cevap 'Belirtilmedi' ise, SADECE hesapladığın sonucu yaz (Örn: '$42$'). ASLA cümle kurma.",
  "recommendations": "🔑 Anahtar Kural: Bu konunun en temel formülü veya kuralı (kısa ve öz).\\n\\n🚩 Kavram Yanılgısı: Bu konuda sık düşülen bir tuzak veya yanlış anlama (kısa ve öz)."
}`;
                    
                    const parsedJson = await callProxyAPI({prompt: prompt, imageBase64Data: imageBase64});
                    setSolution(parsedJson); 
                    setStatus('success');
                } catch (err) { 
                    setError(`Bir hata oluştu: ${err.message}`); 
                    setStatus('error'); 
                } finally { 
                    setLoadingMessage(''); 
                } 
            };

            const handleAskTeacher = async () => {
                if (!teacherQuestion.trim()) return;
                const newChatHistory = [...chatHistory, { role: 'user', content: teacherQuestion }];
                setChatHistory(newChatHistory);
                const currentQuestion = teacherQuestion;
                setTeacherQuestion('');
                setIsChatLoading(true);
                try {
                    const prompt = `### "ÖĞRETMENE SOR" PROTOKOLÜ ###

**1. PERSONA: PEDAGOJİK MENTOR "BERKANT HOCA"**
Sen, bir önceki soruyu çözmüş olan uzman eğitimcisin. Öğrencinin mesajını, orijinal soruyu ve verdiğin çözümü dikkate alarak, aşağıdaki durumsal mantığa göre cevap ver.

**2. DURUM ANALİZİ (Öğrencinin Niyetini Anla)**
   - **Niyet 1: Anlaşılmayan Nokta/Soru** (Örn: "3. adımı anlamadım", "Neden o formülü kullandık?")
   - **Niyet 2: Teşekkür/Onay** (Örn: "teşekkür ederim", "anladım", "sağ olun hocam")
   - **Niyet 3: Konu Dışı/Alakasız Yorum**

**3. CEVAP ÜRETİMİ (Niyete Göre Cevap Ver)**
   * **Eğer Niyet 1 (Soru) ise, BU FORMATTA CEVAP VER:**
     "Elbette, hemen açıklayayım. O adımı kullanmamızın sebebi şuydu: ... (Basit, sabırlı ve daha detaylı bir açıklama yap. Gerekirse matematiksel ifadeleri $...$ içinde kullan.)"
   * **Eğer Niyet 2 (Teşekkür) ise, BU CEVABI VER:**
     "Rica ederim, ne demek! Anlamana sevindim. Unutma, sormaktan çekinme, her soru yeni bir öğrenme fırsatıdır. Başarılar dilerim! 😊"
   * **Eğer Niyet 3 (Konu Dışı) ise, BU CEVABI VER:**
     "Sevgili öğrencim, benim uzmanlık alanım ve şu anki görevim, gönderdiğin soruyu en iyi şekilde anlamana yardımcı olmak. Farklı bir konu hakkında yorum yapamam ama bu soruyla ilgili aklına takılan her şeyi memnuniyetle açıklarım!"

**4. KESİN KURALLAR**
   - **ASLA KALIN PUNTO KULLANMA.**
   - Sadece matematiksel ifadeleri, değişkenleri ve sayıları tek dolar '$...$' arasına al.

**5. BAĞLAM BİLGİLERİ**
   - **Çözülen Soru Özeti:** "${solution.simplified_question}"
   - **Verilen Cevap:** "${solution.final_answer}"
   - **Öğrencinin Yeni Mesajı:** "${currentQuestion}"

**Şimdi, bu yönergelere göre öğrencinin mesajına en uygun ve profesyonel cevabı oluştur.**`;
                    
                    const modelResponse = await callProxyAPI({prompt: prompt, isChat: true});
                    setChatHistory(prev => [...prev, { role: 'model', content: modelResponse }]);
                } catch (err) { 
                    setChatHistory(prev => [...prev, { role: 'model', content: `Üzgünüm, bir hata oluştu: ${err.message}` }]); 
                } finally { 
                    setIsChatLoading(false); 
                }
            };

            const reset = () => { setImage(null); setImageBase64(''); setSelectedSubject(null); setSolution(null); setStatus('idle'); setError(''); setShowAskTeacher(false); setChatHistory([]); setTeacherQuestion(''); setShowFeedbackButtons(true); setToastMessage(''); if (fileInputRef.current) fileInputRef.current.value = ""; };
            const handleLike = () => { setToastMessage("Değerlendirmen için teşekkürler! Bu çözüm, gelecekteki sorular için referans olacaktır. ✨"); setShowFeedbackButtons(false); };
            
            return { image, selectedSubject, solution, status, loadingMessage, error, fileInputRef, handleFileChange, triggerFileSelect, setSelectedSubject, startSolutionProcess, reset, showAskTeacher, setShowAskTeacher, teacherQuestion, setTeacherQuestion, chatHistory, isChatLoading, handleAskTeacher, toastMessage, showFeedbackButtons, handleLike };
        };

        const SoruCozucuPage = ({ user, onLogout }) => {
            const { image, selectedSubject, solution, status, loadingMessage, error, fileInputRef, handleFileChange, triggerFileSelect, setSelectedSubject, startSolutionProcess, reset, showAskTeacher, setShowAskTeacher, teacherQuestion, setTeacherQuestion, chatHistory, isChatLoading, handleAskTeacher, toastMessage, showFeedbackButtons, handleLike } = useSoruCozucu();
            const subjects = ['Matematik', 'Fizik', 'Kimya', 'Biyoloji', 'Tarih', 'Coğrafya', 'Edebiyat', 'Türkçe'];
            const [showCorrectionPrompt, setShowCorrectionPrompt] = useState(false);
            const [correctionText, setCorrectionText] = useState('');
            const handleReSolve = () => { setShowCorrectionPrompt(false); startSolutionProcess(null, correctionText); };
            
            const isLoading = status === 'loading';

            return ( 
                <div className="w-full max-w-4xl mx-auto bg-slate-800/50 backdrop-blur-xl border border-slate-700 rounded-2xl shadow-2xl p-4 sm:p-6 md:p-8 text-slate-200"> 
                    <header className="text-center mb-6 relative"> 
                        <button onClick={onLogout} className="absolute top-0 right-0 -mt-2 -mr-2 px-3 py-1 bg-red-500 text-white text-sm font-semibold rounded-full hover:bg-red-600 transition-colors shadow-lg">Çıkış Yap</button>
                        <div className="flex justify-center mb-4"><div className="w-48 p-2 bg-white/10 rounded-lg shadow-lg"><img src="https://i.imgur.com/GtXn6lU.jpeg" alt="Soru Çözücü Logosu" className="rounded-md" onError={(e) => e.target.src='https://placehold.co/192x108/ccc/ffffff?text=Logo'} /></div></div> 
                        <p className="halkali-title text-lg font-semibold mb-2">Her Soru, Yeni Bir Keşif</p> 
                        <h1 className="text-3xl sm:text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-400 to-indigo-400">Soru Çözücü</h1> 
                        <p className="text-base font-semibold bg-gradient-to-r from-sky-400 to-violet-400 bg-clip-text text-transparent mt-2">Berkant Hoca</p> 
                    </header> 
                    <AlertDisplay message={error} type="error" />
                    <div className="flex flex-col gap-6"> 
                        {/* Başlangıç ve Seçim Ekranı */}
                        <div className="w-full flex flex-col items-center justify-center bg-slate-900/50 p-4 sm:p-6 rounded-lg border-2 border-dashed border-slate-600"> 
                            {image ? ( 
                                <div className="w-full text-center">
                                    <img src={image} alt="Yüklenen Soru" className="max-w-full max-h-60 mx-auto rounded-lg shadow-md" />
                                    {status !== 'loading' && <button onClick={reset} className="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700">Yeni Soru Yükle</button>}
                                </div> 
                            ) : ( 
                                <div className="text-center py-8 cursor-pointer w-full" onClick={triggerFileSelect}>
                                    <svg className="mx-auto h-12 w-12 text-slate-500" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" /></svg>
                                    <p className="mt-2 text-sm font-medium text-slate-400">1. Adım: Fotoğraf Yükle</p>
                                </div> 
                            )} 
                            <input type="file" accept="image/*" onChange={handleFileChange} ref={fileInputRef} className="hidden" /> 
                        </div> 
                        
                        {image && !solution && status !== 'loading' && (
                            <>
                                {!selectedSubject && ( <div className="w-full pt-4 border-t border-slate-700"><h2 className="text-lg font-semibold text-center text-slate-300 mb-3">2. Adım: Dersi Seç</h2><div className="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3">{subjects.map(subject => (<button key={subject} onClick={() => setSelectedSubject(subject)} className={`py-2 px-3 rounded-lg font-semibold transition-all duration-200 text-sm sm:text-base ${selectedSubject === subject ? 'rainbow-active' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}>{subject}</button>))}</div></div> )} 
                                {selectedSubject && ( <div className="w-full pt-4 border-t border-slate-700 text-center"><h2 className="text-lg font-semibold text-center text-slate-300 mb-4">3. Adım: Cevabı Seç ve Çözümü Başlat</h2><p className="text-sm text-slate-400 mb-4">Seçilen Ders: <span className="font-bold text-violet-400">{selectedSubject}</span></p><div className="flex justify-center items-center gap-3 flex-wrap">{['A', 'B', 'C', 'D', 'E'].map((option, index) => { const colors = ['bg-sky-500 hover:bg-sky-600', 'bg-emerald-500 hover:bg-emerald-600', 'bg-amber-500 hover:bg-amber-600', 'bg-rose-500 hover:bg-rose-600', 'bg-violet-500 hover:bg-violet-600']; return <button key={option} onClick={() => startSolutionProcess(option)} className={`answer-button w-12 h-12 flex items-center justify-center text-white font-bold text-lg rounded-full shadow-lg ${colors[index]}`}>{option}</button> })}</div><div className="mt-4"><button onClick={() => startSolutionProcess(null)} className="answer-button w-full sm:w-auto px-6 py-2 border-2 border-slate-500 text-slate-300 font-semibold rounded-full hover:bg-slate-700 hover:border-slate-400">Cevabı Bilmiyorum / Şık Yok</button></div></div> )} 
                            </>
                        )}
                        
                        {isLoading && <LoadingIndicator message={loadingMessage} />} 
                        
                        {solution && status === 'success' && (
                            <>
                                <SolutionDisplay solution={solution} subject={selectedSubject} />
                                <div className="text-center pt-4"><button onClick={() => setShowAskTeacher(!showAskTeacher)} className="bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-150">👩‍🏫 Öğretmene Sor</button></div>
                                {showAskTeacher && (
                                   <div className="mt-6 bg-slate-900/50 p-5 rounded-xl border border-slate-700">
                                        <h3 className="text-lg font-bold text-slate-200 mb-4 text-center">Aklına Takılan Bir Yer Mi Var?</h3>
                                        <div className="space-y-4 mb-4 max-h-60 overflow-y-auto pr-2">
                                            {chatHistory.map((chat, index) => (<div key={index} className={`flex ${chat.role === 'user' ? 'justify-end' : 'justify-start'}`}><div className={`max-w-xs md:max-w-md p-3 rounded-2xl ${chat.role === 'user' ? 'bg-violet-600 text-white' : 'bg-slate-700 text-slate-200'}`}><UniversalMathRenderer text={chat.content} baseTextColor="text-slate-200" /></div></div>))}
                                            {isChatLoading && <div className="flex justify-start"><div className="p-3 rounded-2xl bg-slate-700"><span className="animate-pulse text-slate-400">...</span></div></div>}
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <textarea value={teacherQuestion} onChange={(e) => setTeacherQuestion(e.target.value)} placeholder="Bu soruyla ilgili merak ettiklerini yaz..." className="w-full p-2 border border-slate-600 bg-slate-800 text-slate-200 rounded-lg focus:ring-2 focus:ring-violet-500 focus:outline-none resize-none" rows="2" onKeyPress={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleAskTeacher(); } }} />
                                            <button onClick={handleAskTeacher} disabled={isChatLoading || !teacherQuestion.trim()} className="bg-violet-600 text-white p-2 rounded-full hover:bg-violet-700 disabled:bg-slate-500 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg></button>
                                        </div>
                                    </div>
                                )}
                                {showFeedbackButtons ? (<div className="mt-6 p-4 bg-slate-700/50 border border-slate-600 rounded-lg text-center"><h3 className="font-semibold text-slate-200 mb-3">Çözüm Faydalı Oldu mu?</h3><div className="flex justify-center gap-4"><button onClick={handleLike} className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">👍 Beğendim</button><button onClick={() => setShowCorrectionPrompt(true)} className="flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">👎 Hatalı/Eksik</button></div></div>) : (toastMessage && (<AlertDisplay message={toastMessage} type="success" />))}
                            </>
                        )}
                        
                        {showCorrectionPrompt && ( <div className="mt-6 p-5 text-center feedback-box"><h3 className="font-semibold text-indigo-100 mb-2 text-lg">Çözümü Geliştirmeme Yardım Et</h3><p className="text-sm text-indigo-200 mb-4">Lütfen gözden kaçırdığım veya yanlış yorumladığım noktayı yaz. Geri bildiriminle soruyu yeniden çözeceğim.</p><textarea className="w-full p-2 border bg-slate-200 text-gray-900 placeholder-gray-500 border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none resize-none" rows="3" placeholder="Örn: Analizde üçgenin ikizkenar olduğunu belirtmemişsin..." value={correctionText} onChange={(e) => setCorrectionText(e.target.value)}></textarea><div className="flex justify-center gap-4 mt-4"><button onClick={handleReSolve} disabled={!correctionText || isLoading} className="font-bold text-white px-4 py-2 rounded-lg transition-all duration-300 ease-in-out shadow-lg hover:shadow-xl transform hover:scale-105 disabled:from-gray-400 disabled:to-gray-500 disabled:scale-100 bg-gradient-to-r from-green-400 to-blue-500 hover:from-green-500 hover:to-blue-600">Gönder ve Yeniden Çöz</button><button onClick={() => setShowCorrectionPrompt(false)} className="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-all">Vazgeç</button></div></div> )} 
                    </div> 
                </div> 
            );
        };

        // ===================================================================================
        // KİMLİK DOĞRULAMA COMPONENT'LERİ
        // ===================================================================================

        const AuthPage = () => {
            const [isLoginView, setIsLoginView] = useState(true);
            const [notification, setNotification] = useState({ message: "", type: "error" });
            const [loading, setLoading] = useState(false);
            const [showForgotPasswordModal, setShowForgotPasswordModal] = useState(false);

            const getFriendlyErrorMessage = (error) => {
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        return 'E-posta adresi veya şifre hatalı. Lütfen tekrar deneyin.';
                    case 'auth/invalid-email':
                        return 'Lütfen geçerli bir e-posta adresi girin.';
                    case 'auth/email-already-in-use':
                        return 'Bu e-posta adresi zaten başka bir hesap tarafından kullanılıyor.';
                    case 'auth/weak-password':
                        return 'Şifre çok zayıf. Lütfen en az 6 karakterli bir şifre seçin.';
                    default:
                        return 'Bir hata oluştu. Lütfen daha sonra tekrar deneyin.';
                }
            };

            const handleLogin = async (email, password) => {
                setLoading(true);
                setNotification({ message: "", type: "error" });
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                     const friendlyMessage = getFriendlyErrorMessage(error);
                     setNotification({ message: friendlyMessage, type: 'error' });
                     setLoading(false);
                }
            };

            const handleSignup = async (email, password, fullName, grade) => {
                setLoading(true);
                setNotification({ message: "", type: "error" });
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    await setDoc(doc(db, "users", user.uid), {
                        fullName: fullName,
                        grade: grade,
                        email: user.email,
                        createdAt: new Date(),
                        isApproved: false
                    });
                    
                } catch (error) {
                    setNotification({ message: getFriendlyErrorMessage(error), type: 'error' });
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="w-full max-w-md mx-auto bg-slate-900/40 backdrop-blur-md border border-slate-700 rounded-2xl shadow-2xl p-6 sm:p-8">
                    {loading && <FullScreenLoader />}
                    {showForgotPasswordModal && (
                        <Modal title="Şifre Yardımı" onClose={() => setShowForgotPasswordModal(false)}>
                           <p>Yeni bir şifre almak veya mevcut şifrenizle ilgili destek için lütfen Berkant Hoca ile doğrudan iletişime geçiniz.</p>
                        </Modal>
                    )}
                    <div className="text-center mb-8">
                         <div className="flex justify-center mb-4"><div className="w-32 p-1 bg-white/10 rounded-lg shadow-lg"><img src="https://i.imgur.com/GtXn6lU.jpeg" alt="Soru Çözücü Logosu" className="rounded-md" onError={(e) => e.target.src='https://placehold.co/128x72/ccc/ffffff?text=Logo'} /></div></div>
                        <h1 className="text-3xl font-extrabold text-slate-100">{isLoginView ? 'Giriş Yap' : 'Hesap Oluştur'}</h1>
                        <p className="text-slate-400 mt-2">Soru Çözücü evrenine hoş geldiniz!</p>
                    </div>
                    <AlertDisplay message={notification.message} type={notification.type} />
                    {isLoginView ? (
                        <LoginForm onSubmit={handleLogin} onForgotPassword={() => setShowForgotPasswordModal(true)} />
                    ) : (
                        <SignupForm onSubmit={handleSignup} />
                    )}
                     <div className="mt-6 text-center">
                        <button onClick={() => { setIsLoginView(!isLoginView); setNotification({ message: "", type: "error" }); }} className="text-sm font-medium text-slate-300 hover:text-white transition-colors">
                            {isLoginView ? 'Hesabınız yok mu? Kayıt Olun' : 'Zaten bir hesabınız var mı? Giriş Yapın'}
                        </button>
                    </div>
                </div>
            );
        };

        const AuthInput = ({ id, type, placeholder, value, onChange, required=true }) => (
             <div>
                <label htmlFor={id} className="sr-only">{placeholder}</label>
                <input 
                    id={id}
                    name={id}
                    type={type}
                    value={value}
                    onChange={onChange}
                    required={required}
                    placeholder={placeholder}
                    className="mt-1 block w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-md shadow-sm text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-violet-500 transition"
                />
            </div>
        );

        const LoginForm = ({ onSubmit, onForgotPassword }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); if (!email || !password) return; onSubmit(email, password); };
            return (
                <form onSubmit={handleSubmit} className="space-y-6">
                    <AuthInput id="email" type="email" placeholder="E-posta Adresi" value={email} onChange={e => setEmail(e.target.value)} />
                    <AuthInput id="password" type="password" placeholder="Şifre" value={password} onChange={e => setPassword(e.target.value)} />
                    <div className="text-right">
                        <button type="button" onClick={onForgotPassword} className="text-sm font-medium text-slate-400 hover:text-slate-200 transition-colors">Şifrenizi mi unuttunuz?</button>
                    </div>
                    <button type="submit" className="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-lg text-base font-medium text-white bg-gradient-to-r from-violet-600 to-blue-600 hover:from-violet-700 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-violet-500 transition-all duration-300 transform hover:scale-105">Giriş Yap</button>
                </form>
            );
        };

        const SignupForm = ({ onSubmit }) => {
            const [email, setEmail] = useState(''); const [password, setPassword] = useState(''); const [confirmPassword, setConfirmPassword] = useState(''); const [fullName, setFullName] = useState(''); const [grade, setGrade] = useState('');
            const [passwordError, setPasswordError] = useState({ message: "", type: "error" });
            const handleSubmit = (e) => {
                e.preventDefault();
                setPasswordError({ message: "", type: "error" });
                if (password !== confirmPassword) { setPasswordError({ message: 'Girilen şifreler uyuşmuyor.', type: 'error' }); return; }
                if (!email || !password || !fullName || !grade) return;
                onSubmit(email, password, fullName, grade);
            };
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <AuthInput id="fullName" type="text" placeholder="Ad Soyad" value={fullName} onChange={e => setFullName(e.target.value)} />
                    <AuthInput id="grade" type="text" placeholder="Sınıf (Örn: 11-A)" value={grade} onChange={e => setGrade(e.target.value)} />
                    <AuthInput id="email" type="email" placeholder="E-posta Adresi" value={email} onChange={e => setEmail(e.target.value)} />
                    <AuthInput id="password" type="password" placeholder="Şifre" value={password} onChange={e => setPassword(e.target.value)} />
                    <AuthInput id="confirmPassword" type="password" placeholder="Şifre Tekrar" value={confirmPassword} onChange={e => setConfirmPassword(e.target.value)} />
                    <AlertDisplay message={passwordError.message} type={passwordError.type} />
                    <button type="submit" className="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-lg text-base font-medium text-white bg-gradient-to-r from-violet-600 to-blue-600 hover:from-violet-700 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-violet-500 transition-all duration-300 transform hover:scale-105">Hesap Oluştur</button>
                </form>
            );
        };
        
        // ===================================================================================
        // ANA UYGULAMA (APP) COMPONENT'İ
        // ===================================================================================

        const App = () => {
            const [authState, setAuthState] = useState({ status: 'loading', user: null });
            const [firebaseError, setFirebaseError] = useState(false);

            useEffect(() => {
                if (!auth || !onAuthStateChanged) {
                    console.error("Firebase Auth servisleri yüklenemedi.");
                    setFirebaseError(true);
                    setAuthState({ status: 'loggedOut', user: null });
                    return;
                }
                
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    if (currentUser) {
                        try {
                            const userDocRef = doc(db, "users", currentUser.uid);
                            const userDoc = await getDoc(userDocRef);

                            if (userDoc.exists() && userDoc.data().isApproved === true) {
                                setAuthState({ status: 'approved', user: currentUser });
                            } else {
                                setAuthState({ status: 'unapproved', user: currentUser });
                            }
                        } catch (err) {
                            console.error("Kullanıcı durumu kontrol edilirken hata:", err);
                            setAuthState({ status: 'loggedOut', user: null });
                        }
                    } else {
                        setAuthState({ status: 'loggedOut', user: null });
                    }
                });
                
                return () => unsubscribe();
            }, []);

            const handleLogout = async () => {
                try {
                    if(auth && signOut) await signOut(auth);
                } catch (error) {
                    console.error("Çıkış yaparken hata oluştu:", error);
                }
            };
            
            const renderContent = () => {
                switch (authState.status) {
                    case 'loading':
                        return <FullScreenLoader />;
                    case 'approved':
                        return <SoruCozucuPage user={authState.user} onLogout={handleLogout} />;
                    case 'unapproved':
                        return <AwaitingApproval onLogout={handleLogout} />;
                    case 'loggedOut':
                    default:
                        return <AuthPage />;
                }
            };

            if (firebaseError) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
                        <AlertDisplay message="Uygulama başlatılamadı. Firebase yapılandırmasını kontrol edin." type="error" />
                    </div>
                );
            }

            const backgroundClass = authState.status === 'approved' ? 'bg-slate-900' : 'animated-gradient';

            return (
                <div className={`min-h-screen w-full flex items-center justify-center p-2 sm:p-4 transition-all duration-500 ${backgroundClass}`}>
                    {authState.status !== 'approved' && <AnimatedBubbles />}
                    <div className="relative z-10 w-full">
                        {renderContent()}
                    </div>
                </div>
            );
        };

        const container = document.getElementById('root');
        if (container) {
            const root = createRoot(container);
            root.render(<App />);
        }
    </script>
</body>
</html>
