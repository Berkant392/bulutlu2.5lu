<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soru Ã‡Ã¶zÃ¼cÃ¼ - Berkant Hoca | Nihai Protokol</title>
    
    <!-- Temel KÃ¼tÃ¼phaneler (Production SÃ¼rÃ¼mleri) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Matematiksel GÃ¶sterim (KaTeX) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    
    <!-- YazÄ± Tipi -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Stil KodlarÄ± -->
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0;
        }
        .animated-gradient {
            background: linear-gradient(-45deg, #1e3a8a, #4c1d95, #3b0764, #2563eb);
            background-size: 400% 400%;
            animation: gradient-move 15s ease infinite;
        }
        @keyframes gradient-move {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .bubbles {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            top: 0;
            left: 0;
            z-index: 0;
        }
        .bubble {
            position: absolute;
            bottom: -150px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: bubble-rise 25s infinite ease-in;
            opacity: 0;
        }
        .bubble:nth-child(1) { width: 40px; height: 40px; left: 10%; animation-duration: 18s; animation-delay: 0s; }
        .bubble:nth-child(2) { width: 20px; height: 20px; left: 20%; animation-duration: 12s; animation-delay: 1s; }
        .bubble:nth-child(3) { width: 50px; height: 50px; left: 25%; animation-duration: 22s; animation-delay: 0s; }
        .bubble:nth-child(4) { width: 80px; height: 80px; left: 35%; animation-duration: 25s; animation-delay: 3s; }
        .bubble:nth-child(5) { width: 35px; height: 35px; left: 50%; animation-duration: 15s; animation-delay: 0s; }
        .bubble:nth-child(6) { width: 45px; height: 45px; left: 65%; animation-duration: 20s; animation-delay: 1s; }
        .bubble:nth-child(7) { width: 25px; height: 25px; left: 75%; animation-duration: 14s; animation-delay: 4s; }
        .bubble:nth-child(8) { width: 65px; height: 65px; left: 90%; animation-duration: 24s; animation-delay: 2s; }
        .bubble:nth-child(9) { width: 15px; height: 15px; left: 85%; animation-duration: 10s; animation-delay: 5s; }
        .bubble:nth-child(10) { width: 40px; height: 40px; left: 5%; animation-duration: 19s; animation-delay: 6s; }
        .bubble:nth-child(11) { width: 55px; height: 55px; left: 30%; animation-duration: 23s; animation-delay: 8s; }
        .bubble:nth-child(12) { width: 20px; height: 20px; left: 58%; animation-duration: 13s; animation-delay: 9s; }
        @keyframes bubble-rise {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 0.7; }
            100% { transform: translateY(-120vh) scale(1.2) rotate(360deg); opacity: 0; }
        }
        .rainbow-active { position: relative; z-index: 1; background: #1a202c; color: white; border: 2px solid transparent; }
        .rainbow-active::before { content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px; background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000); background-size: 400%; border-radius: 0.5rem; z-index: -1; animation: rainbow-move 3s linear infinite; }
        @keyframes rainbow-move { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
        
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #818cf8; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .halkali-title { animation: text-color-change 6s linear infinite; }
        @keyframes text-color-change { 0% {color: #a78bfa;} 25% {color: #f472b6;} 50% {color: #34d399;} 75% {color: #fb923c;} 100% {color: #a78bfa;} }
        
        .answer-button { transition: all 0.2s ease-in-out; }
        .answer-button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .feedback-box { 
            position: relative; 
            z-index: 1; 
            border-radius: 12px; 
            background: linear-gradient(135deg, #1e293b, #312e81);
            color: white; 
            padding: 20px; 
            overflow: hidden; 
            border: 1px solid #4f46e5;
        }

        .katex { color: #d1d5db; }
        .inline-math { 
            display: inline-block; 
            background-color: rgba(71, 85, 105, 0.5); 
            padding: 2px 8px; 
            border-radius: 6px; 
            margin: 0 4px; 
            border: 1px solid #475569; 
            vertical-align: baseline; 
            font-weight: normal !important; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        // Firebase v9+ SDK'larÄ± modÃ¼l olarak iÃ§e aktarÄ±lÄ±r.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
        import { 
            getFirestore,
            doc,
            getDoc,
            setDoc
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        // Firebase YapÄ±landÄ±rmasÄ±
        const firebaseConfig = {  
            apiKey: "AIzaSyCl6OUQfR8BvI3S2EJ0pVA-I1-r-JX0aBU",  
            authDomain: "paylassorucozucu.firebaseapp.com",  
            projectId: "paylassorucozucu",  
            storageBucket: "paylassorucozucu.appspot.com",  
            messagingSenderId: "447054434464",  
            appId: "1:447054434464:web:635924b4d7f37c5f4b39c5"  
        };
        
        let firebaseServices = null;
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            firebaseServices = { auth, db, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, doc, setDoc, getDoc };
        } catch (error) {
            console.error("Firebase baÅŸlatÄ±lamadÄ±! LÃ¼tfen firebaseConfig bilgilerini kontrol edin.", error);
            firebaseServices = {}; 
        }
        window.firebaseServices = firebaseServices;
    </script>
    
    <script type="text/babel" data-type="module">
        const { useState, useRef, useEffect, useMemo } = React;
        const { createRoot } = ReactDOM;
        
        const {
            auth, db, onAuthStateChanged, createUserWithEmailAndPassword,
            signInWithEmailAndPassword, signOut, doc, setDoc, getDoc
        } = window.firebaseServices || {};

        // ===================================================================================
        // TASARIM COMPONENT'LERÄ°
        // ===================================================================================
        const AnimatedBubbles = () => (
            <div className="bubbles">
                {Array.from({ length: 12 }).map((_, i) => <div key={i} className="bubble"></div>)}
            </div>
        );

        const AwaitingApproval = ({ onLogout }) => {
            return (
                <div className="w-full max-w-md mx-auto bg-slate-900/40 backdrop-blur-md border border-slate-700 rounded-2xl shadow-2xl p-6 sm:p-8 text-center">
                    <h1 className="text-3xl font-extrabold text-slate-100">Onay Bekleniyor</h1>
                    <p className="text-slate-300 mt-4">
                        HesabÄ±nÄ±z baÅŸarÄ±yla oluÅŸturuldu. UygulamayÄ± kullanabilmek iÃ§in yÃ¶neticinin hesabÄ±nÄ±zÄ± onaylamasÄ± gerekmektedir.
                    </p>
                    <p className="text-slate-400 mt-2 text-sm">
                        LÃ¼tfen daha sonra tekrar deneyin.
                    </p>
                    <button 
                        onClick={onLogout}
                        className="w-full mt-8 flex justify-center py-3 px-4 border border-transparent rounded-md shadow-lg text-base font-medium text-white bg-gradient-to-r from-violet-600 to-blue-600 hover:from-violet-700 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-violet-500 transition-all duration-300 transform hover:scale-105"
                    >
                        Ã‡Ä±kÄ±ÅŸ Yap
                    </button>
                </div>
            );
        };

        // ===================================================================================
        // YARDIMCI VE UI COMPONENT'LERÄ°
        // ===================================================================================
        const LoadingIndicator = ({ message }) => (<div className="mt-4 flex flex-col items-center justify-center"><div className="loader"></div><p className="text-slate-400 mt-2 text-center">{message}</p></div>);
        const FullScreenLoader = () => (<div className="fixed inset-0 bg-slate-900 bg-opacity-75 flex items-center justify-center z-50"><div className="loader"></div></div>);
        
        const AlertDisplay = ({ message, type = 'error' }) => {
            if (!message) return null;
            const baseClasses = "px-4 py-3 rounded-lg relative mb-4 text-center text-sm";
            const typeClasses = {
                error: "bg-pink-500/20 border border-pink-500/30 text-pink-300",
                success: "bg-green-500/20 border border-green-500/30 text-green-300"
            };
            return <div className={`${baseClasses} ${typeClasses[type]}`} role="alert">{message}</div>;
        };
        
        const Modal = ({ title, children, onClose }) => (
            <div className="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                <div className="bg-slate-800/70 border border-slate-700 rounded-lg shadow-2xl max-w-sm w-full">
                    <div className="p-5 border-b border-slate-700"><h3 className="text-xl font-bold text-slate-100">{title}</h3></div>
                    <div className="p-5 text-slate-300">{children}</div>
                    <div className="p-4 bg-slate-900/50 border-t border-slate-700 text-right">
                        <button onClick={onClose} className="px-4 py-2 bg-violet-600 text-white font-semibold rounded-lg hover:bg-violet-700 transition-colors">AnladÄ±m</button>
                    </div>
                </div>
            </div>
        );

        const KatexRenderer = ({ content, isBlock }) => {
            const katexRef = useRef(null);
            useEffect(() => { 
                if (katexRef.current && typeof window.katex !== 'undefined' && content) { 
                    try { 
                        window.katex.render(content, katexRef.current, { throwOnError: false, displayMode: isBlock }); 
                    } catch (e) { 
                        console.error("KaTeX render error:", e); 
                        katexRef.current.textContent = content; 
                    } 
                } 
            }, [content, isBlock]);
            return isBlock 
                ? <div ref={katexRef} className="my-2 text-center"></div> 
                : <span ref={katexRef} className="inline-math"></span>;
        };
        
        const renderLineWithMath = (line) => {
            const parts = line.split(/(\$\$[\s\S]*?\$\$|\$[\s\S]*?\$)/g).filter(Boolean);
            return parts.map((part, partIndex) => {
                if (part.startsWith('$$') && part.endsWith('$$')) { return <KatexRenderer key={partIndex} content={part.slice(2, -2)} isBlock={true} />; }
                if (part.startsWith('$') && part.endsWith('$')) { return <KatexRenderer key={partIndex} content={part.slice(1, -1)} isBlock={false} />; }
                return <span key={partIndex}>{part}</span>;
            });
        };

        const UniversalMathRenderer = ({ text, baseTextColor = 'text-slate-300' }) => {
            const parsedContent = useMemo(() => {
                if (!text) return null;
                // \n karakterlerini gerÃ§ek satÄ±r sonlarÄ±na Ã§evir
                const lines = text.replace(/\\n/g, '\n').split('\n');
                return lines.map((line, lineIndex) => (
                    <p key={lineIndex} className={`flex items-baseline flex-wrap ${baseTextColor}`}>{renderLineWithMath(line)}</p>
                ));
            }, [text]);
            return <div>{parsedContent}</div>;
        };

        // ===================================================================================
        // SORU Ã‡Ã–ZÃœCÃœ UYGULAMASI
        // ===================================================================================
        const SolutionDisplay = ({ solution, subject }) => {
            const { simplified_question, solution_steps, final_answer, recommendations } = solution;
            const cleanFinalAnswer = (answer) => answer ? answer.replace(/[\$\*]/g, '') : '';
            
            const steps = solution_steps ? solution_steps.split(/\n\n(?=ğŸ¯|ğŸ”¢|â¡ï¸|âœ…|ğŸ’¡|ğŸ”|ğŸ“|ğŸ“Œ|âœ”ï¸|â•|â–|â—|âœ–ï¸|ï¿½)/) : [];
            const recommendation_parts = recommendations ? recommendations.split(/\n\n(?=ğŸ”‘|ğŸš©)/) : [];

            return (
                <div className="space-y-6 mt-6 pt-6 border-t border-slate-700">
                    <div className="text-center"><h2 className="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">  {subject} Sorusu Ã‡Ã¶zÃ¼mÃ¼</h2></div>
                    
                    {simplified_question && <div className="bg-slate-800/50 p-4 sm:p-5 rounded-lg border-l-4 border-amber-400"><h3 className="flex items-center gap-x-3 text-lg text-amber-300 mb-3"><span className="text-2xl">ğŸ¤”</span><span>Soruyu BasitleÅŸtirelim!</span></h3><UniversalMathRenderer text={simplified_question} /></div>}
                    
                    {steps.length > 0 && (
                        <div className="bg-slate-800/50 p-4 sm:p-5 rounded-lg border-l-4 border-sky-400">
                            <h3 className="flex items-center gap-x-3 text-lg text-sky-300 mb-4"><span className="text-2xl">ğŸš€</span><span>Ã‡Ã¶zÃ¼m AdÄ±mlarÄ±</span></h3>
                            <div className="space-y-3">
                                {steps.map((step, index) => {
                                    const emojiMatch = step.match(/^(ğŸ¯|ğŸ”¢|â¡ï¸|âœ…|ğŸ’¡|ğŸ”|ğŸ“|ğŸ“Œ|âœ”ï¸|â•|â–|â—|âœ–ï¸|ğŸŸ°)\s*/);
                                    const emoji = emojiMatch ? emojiMatch[0] : null;
                                    const restOfStep = emoji ? step.substring(emoji.length) : step;
                                    return (
                                        <div key={index} className="flex items-start p-3 bg-slate-700/40 rounded-lg">
                                            {emoji && <span className="text-xl mr-3 mt-1">{emoji}</span>}
                                            <div className="flex-1 text-slate-300 leading-relaxed"><UniversalMathRenderer text={restOfStep} /></div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {final_answer && <div className="flex justify-center items-center gap-3 p-4 bg-green-800/30 border border-green-500/30 rounded-lg"><h3 className="flex items-center gap-x-3 text-lg text-green-300"><span className="text-2xl">ğŸ‰</span><span>Nihai Cevap:</span></h3><div className="text-lg text-green-200"><KatexRenderer content={cleanFinalAnswer(final_answer)} isBlock={false} /></div></div>}
                    
                    {recommendation_parts.length > 0 && (
                         <div className="bg-slate-800/50 p-4 sm:p-5 rounded-lg border-l-4 border-teal-400">
                             <h3 className="flex items-center gap-x-3 text-lg text-teal-300 mb-4"><span className="text-2xl">ğŸ“š</span><span>Berkant Hoca'dan Tavsiyeler</span></h3>
                             <div className="space-y-4">
                                {recommendation_parts.map((rec, index) => {
                                    const emojiMatch = rec.match(/^(ğŸ”‘|ğŸš©)\s*/);
                                    const emoji = emojiMatch ? emojiMatch[0] : null;
                                    const restOfRec = emoji ? rec.substring(emoji.length) : rec;
                                    return(
                                        <div key={index} className="flex items-start">
                                             {emoji && <span className="text-xl mr-3 mt-1">{emoji}</span>}
                                             <div className="flex-1 text-slate-300 leading-relaxed"><UniversalMathRenderer text={restOfRec} /></div>
                                        </div>
                                    )
                                })}
                             </div>
                         </div>
                    )}
                </div>
            );
        };

        const useSoruCozucu = () => {
            const [image, setImage] = useState(null); const [imageBase64, setImageBase64] = useState(''); const [selectedSubject, setSelectedSubject] = useState(null); const [solution, setSolution] = useState(null); 
            const [status, setStatus] = useState('idle'); // idle, loading, success, error
            const [loadingMessage, setLoadingMessage] = useState(''); const [error, setError] = useState(''); const fileInputRef = useRef(null);
            const [showAskTeacher, setShowAskTeacher] = useState(false); const [teacherQuestion, setTeacherQuestion] = useState(''); const [chatHistory, setChatHistory] = useState([]); const [isChatLoading, setIsChatLoading] = useState(false);
            const [toastMessage, setToastMessage] = useState(''); const [showFeedbackButtons, setShowFeedbackButtons] = useState(true);
            const handleFileChange = (event) => { const file = event.target.files[0]; if (file) { reset(); setImage(URL.createObjectURL(file)); const reader = new FileReader(); reader.onloadend = () => setImageBase64(reader.result.split(',')[1]); reader.onerror = () => setError('Dosya okunurken bir hata oluÅŸtu.'); reader.readAsDataURL(file); } };
            const triggerFileSelect = () => fileInputRef.current?.click();
            
            const callProxyAPI = async (payload) => {
                const proxyUrl = '/.netlify/functions/gemini-proxy';
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: { message: 'Sunucudan geÃ§ersiz bir hata yanÄ±tÄ± alÄ±ndÄ±.'} }));
                    const errorMessage = errorData.error?.message || `Proxy HatasÄ± (${response.status})`;
                    throw new Error(errorMessage);
                }
                const result = await response.json();
                if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                    return payload.isChat ? result.candidates[0].content.parts[0].text : JSON.parse(result.candidates[0].content.parts[0].text);
                } else {
                    console.error("Unexpected API response from proxy:", result);
                    if(result.promptFeedback && result.promptFeedback.blockReason) {
                         throw new Error(`Ä°stek, gÃ¼venlik nedeniyle engellendi: ${result.promptFeedback.blockReason}`);
                    }
                    throw new Error('Proxy\'den beklenen formatta bir yanÄ±t alÄ±namadÄ±.');
                }
            };

            const startSolutionProcess = async (userAnswer, correctionText = null) => { 
                if (!imageBase64 || !selectedSubject) { setError('LÃ¼tfen Ã¶nce bir resim yÃ¼kleyip ders seÃ§in.'); return; } 
                setStatus('loading'); setLoadingMessage('Soru derinlemesine analiz ediliyor...'); setError(''); setSolution(null); setShowFeedbackButtons(true);
                try { 
                    const prompt = `### PLATÄ°N STANDART PROTOKOLÃœ V7 - NÄ°HAÄ° MÃœHÃœR ###

**1. PERSONA: PEDAGOJÄ°K MENTOR "BERKANT HOCA"**
Sen, adÄ± "Berkant Hoca" olan, ${selectedSubject} alanÄ±nda uzman, son derece bilgili ve pedagojik bir yapay zeka eÄŸitimcisin. GÃ¶revin sadece soruyu Ã§Ã¶zmek deÄŸil, Ã¶ÄŸrencinin konuyu temelden anlamasÄ±nÄ± saÄŸlamaktÄ±r. Empati kur, sabÄ±rlÄ± ol ve en karmaÅŸÄ±k konularÄ± bile basit analojilerle aÃ§Ä±kla.

**2. ZORUNLU Ä°Ã‡SEL DÃœÅÃœNCE ZÄ°NCÄ°RÄ° (CEVABI ÃœRETMEDEN Ã–NCE BUNLARI DÃœÅÃœN)**
   a. **DÃœÅÃœN (DECONSTRUCT):** Sorudaki tÃ¼m verileri, metinleri, sayÄ±larÄ±, ÅŸekilleri ve gizli bilgileri ayrÄ±ÅŸtÄ±r. "Verilenler ne?", "Ä°stenen ne?", "Sorunun altÄ±nda yatan temel prensip ne?"
   b. **PLANLA (BLUEPRINT):** Ã‡Ã¶zÃ¼me giden en mantÄ±klÄ± ve en basit yol haritasÄ±nÄ± adÄ±m adÄ±m planla.
   c. **UYGULA (GENERATE):** TÃ¼m bu analizleri tamamladÄ±ktan sonra, bulgularÄ±nÄ± aÅŸaÄŸÄ±da belirtilen JSON formatÄ±nda, kusursuz bir ÅŸekilde dÄ±ÅŸa aktar.

**3. LATEX FORMATLAMA - KATI KURALLAR (HATA PAYI SIFIR!)**
   a. **KOPYA KAÄIDI (Sadece BunlarÄ± Kullan):**
      - Ã‡arpma iÃ§in: \`\\\\times\`
      - BÃ¶lme iÃ§in: \`\\\\div\`
      - Kesir iÃ§in: \`\\\\frac{pay}{payda}\`
      - KarekÃ¶k iÃ§in: \`\\\\sqrt{ifade}\`
      - ÃœslÃ¼ ifade iÃ§in: \`x^2\`
      - Metin iÃ§inde formÃ¼l: \`$...$\`
      - AyrÄ± satÄ±rda formÃ¼l: \`$$...$$\`
      - TÃ¼rkÃ§e metinler iÃ§in: Sadece ve sadece birimler veya Ã¶zel isimler gibi durumlarda \`\\\\text{...}\` kullan. Ã–rnek: \`V_{\\\\text{otobÃ¼s}}\`
   b. **KESÄ°NLÄ°KLE YASAKLI FORMATLAR (BunlarÄ± ASLA Kullanma):**
      - Markdown formatlarÄ±: \`**\`, \`*\`, \`#\` vb. KESÄ°NLÄ°KLE YASAKTIR.
      - AnlamsÄ±z LaTeX birleÅŸtirmeleri: \`ext\`, \`imes\`, \`Vimest\` vb.
      - Tek ters taksimli LaTeX komutlarÄ±: \`\\times\`, \`\\frac\` vb. (JSON iÃ§in her zaman Ã§ift olmalÄ±: \`\\\\times\`).
      - Matematiksel bir ifadeyi birden fazla '$' bloÄŸuna bÃ¶lmek. (YANLIÅ: \`$x$ = $5$\`. DOÄRU: \`$x = 5$\`.)
   c. **JSON UYUMLULUÄU:** JSON iÃ§inde tÃ¼m ters taksimler ('\') Ã§ift olmalÄ±dÄ±r ('\\\\').

**4. ZORUNLU KENDÄ°NÄ° ELEÅTÄ°RME (JSON ÃœRETMEDEN Ã–NCEKÄ° SON KONTROL)**
   - YasaklÄ± formatlardan birini kullandÄ±m mÄ±? (KullanmamalÄ±sÄ±n).
   - JSON formatÄ±m geÃ§erli mi? TÃ¼m 4 anahtar da dolu mu?
   - **LATEX KONTROLÃœ:** YasaklÄ± listeden bir komut kullandÄ±m mÄ±? KomutlarÄ±m kopya kaÄŸÄ±dÄ±ndaki gibi mi? TÃ¼m taksimlerim Ã§ift mi?
   - **NÄ°HAÄ° CEVAP KONTROLÃœ:** \`final_answer\` alanÄ±na SADECE nihai cevabÄ± (ÅŸÄ±k veya sonuÃ§) mÄ± yazdÄ±m? Ä°Ã§inde KESÄ°NLÄ°KLE cÃ¼mle var mÄ±? (OlmamalÄ±).
   - CevaplarÄ±m, "Berkant Hoca" personasÄ±na uygun, anlaÅŸÄ±lÄ±r ve pedagojik mi?

**5. DÄ°NAMÄ°K GERÄ° BÄ°LDÄ°RÄ°M ENTEGRASYONU**
${correctionText ? `- **Ã–NCEKÄ° HATADAN DERS Ã‡IKAR:** Daha Ã¶nce bu soruya bir Ã§Ã¶zÃ¼m sundun ama kullanÄ±cÄ± ÅŸu geri bildirimi yaptÄ±: "${correctionText}". Bu yeni ve kritik bilgiyi dikkate alarak, dÃ¼ÅŸÃ¼nce zincirini ve Ã§Ã¶zÃ¼mÃ¼nÃ¼ yeniden oluÅŸtur. HatayÄ± kabul et ve dÃ¼zelt.` : ''}

**6. GÃ–REV: JSON Ã‡IKTISI ÃœRET**
YukarÄ±daki tÃ¼m protokolÃ¼ takip ederek, verilen ${selectedSubject} sorusu iÃ§in aÅŸaÄŸÄ±daki 4 anahtarÄ± iÃ§eren bir JSON nesnesi oluÅŸtur.

### GÄ°RDÄ° BÄ°LGÄ°LERÄ° ###
- **Ders:** ${selectedSubject}
- **KullanÄ±cÄ±nÄ±n VerdiÄŸi Cevap:** ${userAnswer || "Belirtilmedi"}

### Ä°STENEN JSON FORMATI ###
{
  "simplified_question": "Bu soruda bizden ne istendiÄŸinin basit bir dille aÃ§Ä±klamasÄ±.",
  "solution_steps": "ğŸ¯ 1. AdÄ±m: ...\\n\\nğŸ”¢ 2. AdÄ±m: ...",
  "final_answer": "EÄŸer kullanÄ±cÄ±nÄ±n cevabÄ± 'A', 'B', 'C', 'D' veya 'E' ise, SADECE o harfi yaz (Ã–rn: '$C$'). EÄŸer cevap 'Belirtilmedi' ise, SADECE hesapladÄ±ÄŸÄ±n sonucu yaz (Ã–rn: '$42$'). ASLA cÃ¼mle kurma.",
  "recommendations": "ğŸ”‘ Anahtar Kural: Bu konunun en temel formÃ¼lÃ¼ veya kuralÄ± (kÄ±sa ve Ã¶z).\\n\\nğŸš© Kavram YanÄ±lgÄ±sÄ±: Bu konuda sÄ±k dÃ¼ÅŸÃ¼len bir tuzak veya yanlÄ±ÅŸ anlama (kÄ±sa ve Ã¶z)."
}`;
                    
                    const parsedJson = await callProxyAPI({prompt: prompt, imageBase64Data: imageBase64});
                    setSolution(parsedJson); 
                    setStatus('success');
                } catch (err) { 
                    setError(`Bir hata oluÅŸtu: ${err.message}`); 
                    setStatus('error'); 
                } finally { 
                    setLoadingMessage(''); 
                } 
            };

            const handleAskTeacher = async () => {
                if (!teacherQuestion.trim()) return;
                const newChatHistory = [...chatHistory, { role: 'user', content: teacherQuestion }];
                setChatHistory(newChatHistory);
                const currentQuestion = teacherQuestion;
                setTeacherQuestion('');
                setIsChatLoading(true);
                try {
                    const prompt = `### "Ã–ÄRETMENE SOR" PROTOKOLÃœ ###

**1. PERSONA: PEDAGOJÄ°K MENTOR "BERKANT HOCA"**
Sen, bir Ã¶nceki soruyu Ã§Ã¶zmÃ¼ÅŸ olan uzman eÄŸitimcisin. Ã–ÄŸrencinin mesajÄ±nÄ±, orijinal soruyu ve verdiÄŸin Ã§Ã¶zÃ¼mÃ¼ dikkate alarak, aÅŸaÄŸÄ±daki durumsal mantÄ±ÄŸa gÃ¶re cevap ver.

**2. DURUM ANALÄ°ZÄ° (Ã–ÄŸrencinin Niyetini Anla)**
   - **Niyet 1: AnlaÅŸÄ±lmayan Nokta/Soru** (Ã–rn: "3. adÄ±mÄ± anlamadÄ±m", "Neden o formÃ¼lÃ¼ kullandÄ±k?")
   - **Niyet 2: TeÅŸekkÃ¼r/Onay** (Ã–rn: "teÅŸekkÃ¼r ederim", "anladÄ±m", "saÄŸ olun hocam")
   - **Niyet 3: Konu DÄ±ÅŸÄ±/AlakasÄ±z Yorum**

**3. CEVAP ÃœRETÄ°MÄ° (Niyete GÃ¶re Cevap Ver)**
   * **EÄŸer Niyet 1 (Soru) ise, BU FORMATTA CEVAP VER:**
     "Elbette, hemen aÃ§Ä±klayayÄ±m. O adÄ±mÄ± kullanmamÄ±zÄ±n sebebi ÅŸuydu: ... (Basit, sabÄ±rlÄ± ve daha detaylÄ± bir aÃ§Ä±klama yap. Gerekirse matematiksel ifadeleri $...$ iÃ§inde kullan.)"
   * **EÄŸer Niyet 2 (TeÅŸekkÃ¼r) ise, BU CEVABI VER:**
     "Rica ederim, ne demek! Anlamana sevindim. Unutma, sormaktan Ã§ekinme, her soru yeni bir Ã¶ÄŸrenme fÄ±rsatÄ±dÄ±r. BaÅŸarÄ±lar dilerim! ğŸ˜Š"
   * **EÄŸer Niyet 3 (Konu DÄ±ÅŸÄ±) ise, BU CEVABI VER:**
     "Sevgili Ã¶ÄŸrencim, benim uzmanlÄ±k alanÄ±m ve ÅŸu anki gÃ¶revim, gÃ¶nderdiÄŸin soruyu en iyi ÅŸekilde anlamana yardÄ±mcÄ± olmak. FarklÄ± bir konu hakkÄ±nda yorum yapamam ama bu soruyla ilgili aklÄ±na takÄ±lan her ÅŸeyi memnuniyetle aÃ§Ä±klarÄ±m!"

**4. KESÄ°N KURALLAR**
   - **ASLA KALIN PUNTO KULLANMA.**
   - Sadece matematiksel ifadeleri, deÄŸiÅŸkenleri ve sayÄ±larÄ± tek dolar '$...$' arasÄ±na al.

**5. BAÄLAM BÄ°LGÄ°LERÄ°**
   - **Ã‡Ã¶zÃ¼len Soru Ã–zeti:** "${solution.simplified_question}"
   - **Verilen Cevap:** "${solution.final_answer}"
   - **Ã–ÄŸrencinin Yeni MesajÄ±:** "${currentQuestion}"

**Åimdi, bu yÃ¶nergelere gÃ¶re Ã¶ÄŸrencinin mesajÄ±na en uygun ve profesyonel cevabÄ± oluÅŸtur.**`;
                    
                    const modelResponse = await callProxyAPI({prompt: prompt, isChat: true});
                    setChatHistory(prev => [...prev, { role: 'model', content: modelResponse }]);
                } catch (err) { 
                    setChatHistory(prev => [...prev, { role: 'model', content: `ÃœzgÃ¼nÃ¼m, bir hata oluÅŸtu: ${err.message}` }]); 
                } finally { 
                    setIsChatLoading(false); 
                }
            };

            const reset = () => { setImage(null); setImageBase64(''); setSelectedSubject(null); setSolution(null); setStatus('idle'); setError(''); setShowAskTeacher(false); setChatHistory([]); setTeacherQuestion(''); setShowFeedbackButtons(true); setToastMessage(''); if (fileInputRef.current) fileInputRef.current.value = ""; };
            const handleLike = () => { setToastMessage("DeÄŸerlendirmen iÃ§in teÅŸekkÃ¼rler! Bu Ã§Ã¶zÃ¼m, gelecekteki sorular iÃ§in referans olacaktÄ±r. âœ¨"); setShowFeedbackButtons(false); };
            
            return { image, selectedSubject, solution, status, loadingMessage, error, fileInputRef, handleFileChange, triggerFileSelect, setSelectedSubject, startSolutionProcess, reset, showAskTeacher, setShowAskTeacher, teacherQuestion, setTeacherQuestion, chatHistory, isChatLoading, handleAskTeacher, toastMessage, showFeedbackButtons, handleLike };
        };

        const SoruCozucuPage = ({ user, onLogout }) => {
            const { image, selectedSubject, solution, status, loadingMessage, error, fileInputRef, handleFileChange, triggerFileSelect, setSelectedSubject, startSolutionProcess, reset, showAskTeacher, setShowAskTeacher, teacherQuestion, setTeacherQuestion, chatHistory, isChatLoading, handleAskTeacher, toastMessage, showFeedbackButtons, handleLike } = useSoruCozucu();
            const subjects = ['Matematik', 'Fizik', 'Kimya', 'Biyoloji', 'Tarih', 'CoÄŸrafya', 'Edebiyat', 'TÃ¼rkÃ§e'];
            const [showCorrectionPrompt, setShowCorrectionPrompt] = useState(false);
            const [correctionText, setCorrectionText] = useState('');
            const handleReSolve = () => { setShowCorrectionPrompt(false); startSolutionProcess(null, correctionText); };
            
            const isLoading = status === 'loading';

            return ( 
                <div className="w-full max-w-4xl mx-auto bg-slate-800/50 backdrop-blur-xl border border-slate-700 rounded-2xl shadow-2xl p-4 sm:p-6 md:p-8 text-slate-200"> 
                    <header className="text-center mb-6 relative"> 
                        <button onClick={onLogout} className="absolute top-0 right-0 -mt-2 -mr-2 px-3 py-1 bg-red-500 text-white text-sm font-semibold rounded-full hover:bg-red-600 transition-colors shadow-lg">Ã‡Ä±kÄ±ÅŸ Yap</button>
                        <div className="flex justify-center mb-4"><div className="w-48 p-2 bg-white/10 rounded-lg shadow-lg"><img src="https://i.imgur.com/GtXn6lU.jpeg" alt="Soru Ã‡Ã¶zÃ¼cÃ¼ Logosu" className="rounded-md" onError={(e) => e.target.src='https://placehold.co/192x108/ccc/ffffff?text=Logo'} /></div></div> 
                        <p className="halkali-title text-lg font-semibold mb-2">Her Soru, Yeni Bir KeÅŸif</p> 
                        <h1 className="text-3xl sm:text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-400 to-indigo-400">Soru Ã‡Ã¶zÃ¼cÃ¼</h1> 
                        <p className="text-base font-semibold bg-gradient-to-r from-sky-400 to-violet-400 bg-clip-text text-transparent mt-2">Berkant Hoca</p> 
                    </header> 
                    <AlertDisplay message={error} type="error" />
                    <div className="flex flex-col gap-6"> 
                        {/* BaÅŸlangÄ±Ã§ ve SeÃ§im EkranÄ± */}
                        <div className="w-full flex flex-col items-center justify-center bg-slate-900/50 p-4 sm:p-6 rounded-lg border-2 border-dashed border-slate-600"> 
                            {image ? ( 
                                <div className="w-full text-center">
                                    <img src={image} alt="YÃ¼klenen Soru" className="max-w-full max-h-60 mx-auto rounded-lg shadow-md" />
                                    {status !== 'loading' && <button onClick={reset} className="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700">Yeni Soru YÃ¼kle</button>}
                                </div> 
                            ) : ( 
                                <div className="text-center py-8 cursor-pointer w-full" onClick={triggerFileSelect}>
                                    <svg className="mx-auto h-12 w-12 text-slate-500" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" /></svg>
                                    <p className="mt-2 text-sm font-medium text-slate-400">1. AdÄ±m: FotoÄŸraf YÃ¼kle</p>
                                </div> 
                            )} 
                            <input type="file" accept="image/*" onChange={handleFileChange} ref={fileInputRef} className="hidden" /> 
                        </div> 
                        
                        {image && !solution && status !== 'loading' && (
                            <>
                                {!selectedSubject && ( <div className="w-full pt-4 border-t border-slate-700"><h2 className="text-lg font-semibold text-center text-slate-300 mb-3">2. AdÄ±m: Dersi SeÃ§</h2><div className="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3">{subjects.map(subject => (<button key={subject} onClick={() => setSelectedSubject(subject)} className={`py-2 px-3 rounded-lg font-semibold transition-all duration-200 text-sm sm:text-base ${selectedSubject === subject ? 'rainbow-active' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}>{subject}</button>))}</div></div> )} 
                                {selectedSubject && ( <div className="w-full pt-4 border-t border-slate-700 text-center"><h2 className="text-lg font-semibold text-center text-slate-300 mb-4">3. AdÄ±m: CevabÄ± SeÃ§ ve Ã‡Ã¶zÃ¼mÃ¼ BaÅŸlat</h2><p className="text-sm text-slate-400 mb-4">SeÃ§ilen Ders: <span className="font-bold text-violet-400">{selectedSubject}</span></p><div className="flex justify-center items-center gap-3 flex-wrap">{['A', 'B', 'C', 'D', 'E'].map((option, index) => { const colors = ['bg-sky-500 hover:bg-sky-600', 'bg-emerald-500 hover:bg-emerald-600', 'bg-amber-500 hover:bg-amber-600', 'bg-rose-500 hover:bg-rose-600', 'bg-violet-500 hover:bg-violet-600']; return <button key={option} onClick={() => startSolutionProcess(option)} className={`answer-button w-12 h-12 flex items-center justify-center text-white font-bold text-lg rounded-full shadow-lg ${colors[index]}`}>{option}</button> })}</div><div className="mt-4"><button onClick={() => startSolutionProcess(null)} className="answer-button w-full sm:w-auto px-6 py-2 border-2 border-slate-500 text-slate-300 font-semibold rounded-full hover:bg-slate-700 hover:border-slate-400">CevabÄ± Bilmiyorum / ÅÄ±k Yok</button></div></div> )} 
                            </>
                        )}
                        
                        {isLoading && <LoadingIndicator message={loadingMessage} />} 
                        
                        {solution && status === 'success' && (
                            <>
                                <SolutionDisplay solution={solution} subject={selectedSubject} />
                                <div className="text-center pt-4"><button onClick={() => setShowAskTeacher(!showAskTeacher)} className="bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-150">ğŸ‘©â€ğŸ« Ã–ÄŸretmene Sor</button></div>
                                {showAskTeacher && (
                                   <div className="mt-6 bg-slate-900/50 p-5 rounded-xl border border-slate-700">
                                        <h3 className="text-lg font-bold text-slate-200 mb-4 text-center">AklÄ±na TakÄ±lan Bir Yer Mi Var?</h3>
                                        <div className="space-y-4 mb-4 max-h-60 overflow-y-auto pr-2">
                                            {chatHistory.map((chat, index) => (<div key={index} className={`flex ${chat.role === 'user' ? 'justify-end' : 'justify-start'}`}><div className={`max-w-xs md:max-w-md p-3 rounded-2xl ${chat.role === 'user' ? 'bg-violet-600 text-white' : 'bg-slate-700 text-slate-200'}`}><UniversalMathRenderer text={chat.content} baseTextColor="text-slate-200" /></div></div>))}
                                            {isChatLoading && <div className="flex justify-start"><div className="p-3 rounded-2xl bg-slate-700"><span className="animate-pulse text-slate-400">...</span></div></div>}
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <textarea value={teacherQuestion} onChange={(e) => setTeacherQuestion(e.target.value)} placeholder="Bu soruyla ilgili merak ettiklerini yaz..." className="w-full p-2 border border-slate-600 bg-slate-800 text-slate-200 rounded-lg focus:ring-2 focus:ring-violet-500 focus:outline-none resize-none" rows="2" onKeyPress={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleAskTeacher(); } }} />
                                            <button onClick={handleAskTeacher} disabled={isChatLoading || !teacherQuestion.trim()} className="bg-violet-600 text-white p-2 rounded-full hover:bg-violet-700 disabled:bg-slate-500 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg></button>
                                        </div>
                                    </div>
                                )}
                                {showFeedbackButtons ? (<div className="mt-6 p-4 bg-slate-700/50 border border-slate-600 rounded-lg text-center"><h3 className="font-semibold text-slate-200 mb-3">Ã‡Ã¶zÃ¼m FaydalÄ± Oldu mu?</h3><div className="flex justify-center gap-4"><button onClick={handleLike} className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">ğŸ‘ BeÄŸendim</button><button onClick={() => setShowCorrectionPrompt(true)} className="flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">ğŸ‘ HatalÄ±/Eksik</button></div></div>) : (toastMessage && (<AlertDisplay message={toastMessage} type="success" />))}
                            </>
                        )}
                        
                        {showCorrectionPrompt && ( <div className="mt-6 p-5 text-center feedback-box"><h3 className="font-semibold text-indigo-100 mb-2 text-lg">Ã‡Ã¶zÃ¼mÃ¼ GeliÅŸtirmeme YardÄ±m Et</h3><p className="text-sm text-indigo-200 mb-4">LÃ¼tfen gÃ¶zden kaÃ§Ä±rdÄ±ÄŸÄ±m veya yanlÄ±ÅŸ yorumladÄ±ÄŸÄ±m noktayÄ± yaz. Geri bildiriminle soruyu yeniden Ã§Ã¶zeceÄŸim.</p><textarea className="w-full p-2 border bg-slate-200 text-gray-900 placeholder-gray-500 border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none resize-none" rows="3" placeholder="Ã–rn: Analizde Ã¼Ã§genin ikizkenar olduÄŸunu belirtmemiÅŸsin..." value={correctionText} onChange={(e) => setCorrectionText(e.target.value)}></textarea><div className="flex justify-center gap-4 mt-4"><button onClick={handleReSolve} disabled={!correctionText || isLoading} className="font-bold text-white px-4 py-2 rounded-lg transition-all duration-300 ease-in-out shadow-lg hover:shadow-xl transform hover:scale-105 disabled:from-gray-400 disabled:to-gray-500 disabled:scale-100 bg-gradient-to-r from-green-400 to-blue-500 hover:from-green-500 hover:to-blue-600">GÃ¶nder ve Yeniden Ã‡Ã¶z</button><button onClick={() => setShowCorrectionPrompt(false)} className="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-all">VazgeÃ§</button></div></div> )} 
                    </div> 
                </div> 
            );
        };

        // ===================================================================================
        // KÄ°MLÄ°K DOÄRULAMA COMPONENT'LERÄ°
        // ===================================================================================

        const AuthPage = () => {
            const [isLoginView, setIsLoginView] = useState(true);
            const [notification, setNotification] = useState({ message: "", type: "error" });
            const [loading, setLoading] = useState(false);
            const [showForgotPasswordModal, setShowForgotPasswordModal] = useState(false);

            const getFriendlyErrorMessage = (error) => {
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        return 'E-posta adresi veya ÅŸifre hatalÄ±. LÃ¼tfen tekrar deneyin.';
                    case 'auth/invalid-email':
                        return 'LÃ¼tfen geÃ§erli bir e-posta adresi girin.';
                    case 'auth/email-already-in-use':
                        return 'Bu e-posta adresi zaten baÅŸka bir hesap tarafÄ±ndan kullanÄ±lÄ±yor.';
                    case 'auth/weak-password':
                        return 'Åifre Ã§ok zayÄ±f. LÃ¼tfen en az 6 karakterli bir ÅŸifre seÃ§in.';
                    default:
                        return 'Bir hata oluÅŸtu. LÃ¼tfen daha sonra tekrar deneyin.';
                }
            };

            const handleLogin = async (email, password) => {
                setLoading(true);
                setNotification({ message: "", type: "error" });
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                     const friendlyMessage = getFriendlyErrorMessage(error);
                     setNotification({ message: friendlyMessage, type: 'error' });
                     setLoading(false);
                }
            };

            const handleSignup = async (email, password, fullName, grade) => {
                setLoading(true);
                setNotification({ message: "", type: "error" });
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    await setDoc(doc(db, "users", user.uid), {
                        fullName: fullName,
                        grade: grade,
                        email: user.email,
                        createdAt: new Date(),
                        isApproved: false
                    });
                    
                } catch (error) {
                    setNotification({ message: getFriendlyErrorMessage(error), type: 'error' });
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="w-full max-w-md mx-auto bg-slate-900/40 backdrop-blur-md border border-slate-700 rounded-2xl shadow-2xl p-6 sm:p-8">
                    {loading && <FullScreenLoader />}
                    {showForgotPasswordModal && (
                        <Modal title="Åifre YardÄ±mÄ±" onClose={() => setShowForgotPasswordModal(false)}>
                           <p>Yeni bir ÅŸifre almak veya mevcut ÅŸifrenizle ilgili destek iÃ§in lÃ¼tfen Berkant Hoca ile doÄŸrudan iletiÅŸime geÃ§iniz.</p>
                        </Modal>
                    )}
                    <div className="text-center mb-8">
                         <div className="flex justify-center mb-4"><div className="w-32 p-1 bg-white/10 rounded-lg shadow-lg"><img src="https://i.imgur.com/GtXn6lU.jpeg" alt="Soru Ã‡Ã¶zÃ¼cÃ¼ Logosu" className="rounded-md" onError={(e) => e.target.src='https://placehold.co/128x72/ccc/ffffff?text=Logo'} /></div></div>
                        <h1 className="text-3xl font-extrabold text-slate-100">{isLoginView ? 'GiriÅŸ Yap' : 'Hesap OluÅŸtur'}</h1>
                        <p className="text-slate-400 mt-2">Soru Ã‡Ã¶zÃ¼cÃ¼ evrenine hoÅŸ geldiniz!</p>
                    </div>
                    <AlertDisplay message={notification.message} type={notification.type} />
                    {isLoginView ? (
                        <LoginForm onSubmit={handleLogin} onForgotPassword={() => setShowForgotPasswordModal(true)} />
                    ) : (
                        <SignupForm onSubmit={handleSignup} />
                    )}
                     <div className="mt-6 text-center">
                        <button onClick={() => { setIsLoginView(!isLoginView); setNotification({ message: "", type: "error" }); }} className="text-sm font-medium text-slate-300 hover:text-white transition-colors">
                            {isLoginView ? 'HesabÄ±nÄ±z yok mu? KayÄ±t Olun' : 'Zaten bir hesabÄ±nÄ±z var mÄ±? GiriÅŸ YapÄ±n'}
                        </button>
                    </div>
                </div>
            );
        };

        const AuthInput = ({ id, type, placeholder, value, onChange, required=true }) => (
             <div>
                <label htmlFor={id} className="sr-only">{placeholder}</label>
                <input 
                    id={id}
                    name={id}
                    type={type}
                    value={value}
                    onChange={onChange}
                    required={required}
                    placeholder={placeholder}
                    className="mt-1 block w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-md shadow-sm text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-violet-500 transition"
                />
            </div>
        );

        const LoginForm = ({ onSubmit, onForgotPassword }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); if (!email || !password) return; onSubmit(email, password); };
            return (
                <form onSubmit={handleSubmit} className="space-y-6">
                    <AuthInput id="email" type="email" placeholder="E-posta Adresi" value={email} onChange={e => setEmail(e.target.value)} />
                    <AuthInput id="password" type="password" placeholder="Åifre" value={password} onChange={e => setPassword(e.target.value)} />
                    <div className="text-right">
                        <button type="button" onClick={onForgotPassword} className="text-sm font-medium text-slate-400 hover:text-slate-200 transition-colors">Åifrenizi mi unuttunuz?</button>
                    </div>
                    <button type="submit" className="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-lg text-base font-medium text-white bg-gradient-to-r from-violet-600 to-blue-600 hover:from-violet-700 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-violet-500 transition-all duration-300 transform hover:scale-105">GiriÅŸ Yap</button>
                </form>
            );
        };

        const SignupForm = ({ onSubmit }) => {
            const [email, setEmail] = useState(''); const [password, setPassword] = useState(''); const [confirmPassword, setConfirmPassword] = useState(''); const [fullName, setFullName] = useState(''); const [grade, setGrade] = useState('');
            const [passwordError, setPasswordError] = useState({ message: "", type: "error" });
            const handleSubmit = (e) => {
                e.preventDefault();
                setPasswordError({ message: "", type: "error" });
                if (password !== confirmPassword) { setPasswordError({ message: 'Girilen ÅŸifreler uyuÅŸmuyor.', type: 'error' }); return; }
                if (!email || !password || !fullName || !grade) return;
                onSubmit(email, password, fullName, grade);
            };
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <AuthInput id="fullName" type="text" placeholder="Ad Soyad" value={fullName} onChange={e => setFullName(e.target.value)} />
                    <AuthInput id="grade" type="text" placeholder="SÄ±nÄ±f (Ã–rn: 11-A)" value={grade} onChange={e => setGrade(e.target.value)} />
                    <AuthInput id="email" type="email" placeholder="E-posta Adresi" value={email} onChange={e => setEmail(e.target.value)} />
                    <AuthInput id="password" type="password" placeholder="Åifre" value={password} onChange={e => setPassword(e.target.value)} />
                    <AuthInput id="confirmPassword" type="password" placeholder="Åifre Tekrar" value={confirmPassword} onChange={e => setConfirmPassword(e.target.value)} />
                    <AlertDisplay message={passwordError.message} type={passwordError.type} />
                    <button type="submit" className="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-lg text-base font-medium text-white bg-gradient-to-r from-violet-600 to-blue-600 hover:from-violet-700 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-violet-500 transition-all duration-300 transform hover:scale-105">Hesap OluÅŸtur</button>
                </form>
            );
        };
        
        // ===================================================================================
        // ANA UYGULAMA (APP) COMPONENT'Ä°
        // ===================================================================================

        const App = () => {
            const [authState, setAuthState] = useState({ status: 'loading', user: null });
            const [firebaseError, setFirebaseError] = useState(false);

            useEffect(() => {
                if (!auth || !onAuthStateChanged) {
                    console.error("Firebase Auth servisleri yÃ¼klenemedi.");
                    setFirebaseError(true);
                    setAuthState({ status: 'loggedOut', user: null });
                    return;
                }
                
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    if (currentUser) {
                        try {
                            const userDocRef = doc(db, "users", currentUser.uid);
                            const userDoc = await getDoc(userDocRef);

                            if (userDoc.exists() && userDoc.data().isApproved === true) {
                                setAuthState({ status: 'approved', user: currentUser });
                            } else {
                                setAuthState({ status: 'unapproved', user: currentUser });
                            }
                        } catch (err) {
                            console.error("KullanÄ±cÄ± durumu kontrol edilirken hata:", err);
                            setAuthState({ status: 'loggedOut', user: null });
                        }
                    } else {
                        setAuthState({ status: 'loggedOut', user: null });
                    }
                });
                
                return () => unsubscribe();
            }, []);

            const handleLogout = async () => {
                try {
                    if(auth && signOut) await signOut(auth);
                } catch (error) {
                    console.error("Ã‡Ä±kÄ±ÅŸ yaparken hata oluÅŸtu:", error);
                }
            };
            
            const renderContent = () => {
                switch (authState.status) {
                    case 'loading':
                        return <FullScreenLoader />;
                    case 'approved':
                        return <SoruCozucuPage user={authState.user} onLogout={handleLogout} />;
                    case 'unapproved':
                        return <AwaitingApproval onLogout={handleLogout} />;
                    case 'loggedOut':
                    default:
                        return <AuthPage />;
                }
            };

            if (firebaseError) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
                        <AlertDisplay message="Uygulama baÅŸlatÄ±lamadÄ±. Firebase yapÄ±landÄ±rmasÄ±nÄ± kontrol edin." type="error" />
                    </div>
                );
            }

            const backgroundClass = authState.status === 'approved' ? 'bg-slate-900' : 'animated-gradient';

            return (
                <div className={`min-h-screen w-full flex items-center justify-center p-2 sm:p-4 transition-all duration-500 ${backgroundClass}`}>
                    {authState.status !== 'approved' && <AnimatedBubbles />}
                    <div className="relative z-10 w-full">
                        {renderContent()}
                    </div>
                </div>
            );
        };

        const container = document.getElementById('root');
        if (container) {
            const root = createRoot(container);
            root.render(<App />);
        }
    </script>
</body>
</html>
